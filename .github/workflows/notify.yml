name: 📧 Email Notifications

on:
  workflow_run:
    workflows: ["🚀 Build and Release"]
    types:
      - completed

jobs:
  email-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set status and prepare email content
      id: status
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "status=✅ SUCCESS" >> $GITHUB_OUTPUT
          echo "emoji=🎉" >> $GITHUB_OUTPUT
          echo "color=#28a745" >> $GITHUB_OUTPUT
        else
          echo "status=❌ FAILED" >> $GITHUB_OUTPUT
          echo "emoji=💥" >> $GITHUB_OUTPUT
          echo "color=#dc3545" >> $GITHUB_OUTPUT
        fi
        
        # Prepare commit info
        COMMIT_SHORT=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-8)
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
    
    - name: Send email notification on success
      if: github.event.workflow_run.conclusion == 'success'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "🎉 Build Success - HTB Academy Scraper ${{ github.event.workflow_run.head_branch }}"
        to: ${{ secrets.EMAIL_TO }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: linear-gradient(135deg, #28a745, #20c997); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="color: white; margin: 0;">🎉 Build Successful!</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
              <h2 style="color: #28a745; margin-top: 0;">📋 Build Details</h2>
              <ul style="list-style: none; padding: 0;">
                <li><strong>🚀 Project:</strong> HTB Academy Scraper</li>
                <li><strong>🌿 Branch:</strong> ${{ github.event.workflow_run.head_branch }}</li>
                <li><strong>📝 Commit:</strong> ${{ steps.status.outputs.commit_short }}</li>
                <li><strong>⏰ Time:</strong> $(date)</li>
              </ul>
            </div>
            
            <div style="margin: 20px 0;">
              <h3>✅ Available Downloads:</h3>
              <ul>
                <li>🪟 <strong>Windows:</strong> .exe installer</li>
                <li>🐧 <strong>Linux:</strong> .AppImage</li>
              </ul>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${{ github.event.workflow_run.html_url }}" 
                 style="background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                📊 View Build Details
              </a>
            </div>
            
            <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 12px; color: #6c757d;">
              <p>Generated by GitHub Actions • Repository: ${{ github.repository }}</p>
            </div>
          </body>
          </html>
    
    - name: Send email notification on failure
      if: github.event.workflow_run.conclusion == 'failure'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "💥 Build Failed - HTB Academy Scraper ${{ github.event.workflow_run.head_branch }}"
        to: ${{ secrets.EMAIL_TO }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: linear-gradient(135deg, #dc3545, #e74c3c); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="color: white; margin: 0;">💥 Build Failed!</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
              <h2 style="color: #dc3545; margin-top: 0;">📋 Failure Details</h2>
              <ul style="list-style: none; padding: 0;">
                <li><strong>🚀 Project:</strong> HTB Academy Scraper</li>
                <li><strong>🌿 Branch:</strong> ${{ github.event.workflow_run.head_branch }}</li>
                <li><strong>📝 Commit:</strong> ${{ steps.status.outputs.commit_short }}</li>
                <li><strong>⏰ Time:</strong> $(date)</li>
              </ul>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin: 20px 0;">
              <h3 style="color: #856404; margin-top: 0;">🔧 Next Steps:</h3>
              <ol style="color: #856404;">
                <li>Check the build logs for error details</li>
                <li>Review recent changes in the commit</li>
                <li>Fix issues and push a new commit</li>
              </ol>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${{ github.event.workflow_run.html_url }}" 
                 style="background: #dc3545; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                🔍 View Error Logs
              </a>
            </div>
            
            <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 12px; color: #6c757d;">
              <p>Generated by GitHub Actions • Repository: ${{ github.repository }}</p>
            </div>
          </body>
          </html>